name: "Schema Generation"
description: "Tests for the gen-schema command"

scenarios:
  - id: exits_zero
    name: "Exits successfully"
    run:
      command: go run ./cmd/gen-schema
      timeout: 30s
    assertions:
      - command: assert_equals 0 ${RUN_OUTPUT}/exit_code

  - id: valid_json_schema_structure
    name: "Produces valid JSON Schema structure"
    run:
      command: go run ./cmd/gen-schema
      timeout: 30s
    assertions:
      - command: assert_contains "$schema" ${RUN_OUTPUT}/stdout
      - command: assert_contains "$defs" ${RUN_OUTPUT}/stdout
      - command: assert_contains "oneOf" ${RUN_OUTPUT}/stdout

  - id: concrete_events_in_oneof
    name: "oneOf contains only concrete event types"
    run:
      command: go run ./cmd/gen-schema
      timeout: 30s
    assertions:
      - command: assert_contains "RunStartEvent" ${RUN_OUTPUT}/stdout
      - command: assert_contains "RunEndEvent" ${RUN_OUTPUT}/stdout
      - command: assert_contains "ContextEnterEvent" ${RUN_OUTPUT}/stdout
      - command: assert_contains "ScenarioExitEvent" ${RUN_OUTPUT}/stdout
      - command: assert_contains "OutputEvent" ${RUN_OUTPUT}/stdout

  - id: no_base_event_in_oneof
    name: "BaseEvent is not a standalone event type"
    run:
      command: "go run ./cmd/gen-schema | grep -c 'BaseEvent' | tr -d '\\n'"
      timeout: 30s
    assertions:
      - command: assert_equals 0 ${RUN_OUTPUT}/stdout

  - id: events_have_common_fields
    name: "Concrete events include inherited fields"
    run:
      command: go run ./cmd/gen-schema
      timeout: 30s
    assertions:
      - command: assert_contains "run_id" ${RUN_OUTPUT}/stdout
      - command: assert_contains "event" ${RUN_OUTPUT}/stdout
      - command: assert_contains "timestamp" ${RUN_OUTPUT}/stdout
